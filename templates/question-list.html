{% extends "base.html" %}
	
{% block content %}
<section id="fh5co-work" data-section="work" class="animated">
		<div class="container">
			<div class="row">
				<div class="col-md-12 section-heading text-center question_container">
					<h3 class="to-animate fadeInUp animated">Select a Question: </h3>
					<div class="row">
						<form id="questions_form" action="{{ url_for('question_page') }}" method=POST class=questions>
						<div class="form-group ">
							<input class="form-control" type="text" name="question" list="questionName" size="160"/>
							<datalist id="questionName">
							<option>For last month return max of balance For every customer where branch = Mountain-View</option>
							<option>For last month return sum of amount For every branch where transaction_type = Deposit</option>
							{% for question in question_list %}
							    <option>{{question}}</option>
							{% endfor %}
							</datalist>
							<br>
							</div>
							<div class="form-group ">
							<input class="btn btn-primary btn-lg" type=submit name=Submit>
							</div>
						</form>
					</div>
				</div>
			</div>
			<div class="row row-bottom-padded-sm">
				<div class="col-xs-offset-2 col-mo-8 col-sm-8 col-xxs-8">
					<div class="fh5co-project-item ">
						<div id="answer_container" style="min-width: 310px; height: 0px; max-width: 600px; margin: 0 auto"></div>
					</div>
				</div>
			</div>
			<div class="row row-bottom-padded-sm">
				<div class="col-mo-6 col-sm-6 col-xxs-12">
					<div class="fh5co-project-item ">
						<div id="bar_container" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
					</div>
				</div>
				<div class="col-mo-6 col-sm-6 col-xxs-12">
					<div class="fh5co-project-item ">
						
						<div id="container" style="min-width: 310px; height: 400px; max-width: 600px; margin: 0 auto"></div>
					</div>
				</div>

				<div class="clearfix visible-sm-block"></div>

				<div class="col-mo-6 col-sm-6 col-xxs-12">
					<div class="fh5co-project-item ">
						
						<div class="fh5co-text">
						<div>Highest withdrawal made</div>
						<div class="timer withdrawal" data-from="0" data-to="100"
      							data-speed="2000" data-refresh-interval="50"></div>
      							<div class="cust_data"> 
								    customer=<span class="customer"></span><br>branch=<span class="branch"></span>
								</div>
						</div>
					</div>
				</div>
				<div class="col-mo-6 col-sm-6 col-xxs-12">
					<div class="fh5co-project-item ">
						
						<div class="fh5co-text">
						<div>Highest deposit made</div>
						<div class="timer deposit" data-from="0" data-to="100" 
      							data-speed="2000" data-refresh-interval="50"></div>
      							<div class="cust_data"> 
								    customer=<span class="customer"></span><br>branch=<span class="branch"></span>
								</div>
						</div>
					</div>
				</div>
				
				<div class="clearfix visible-sm-block"></div>

				
			</div>
	</section>

{% endblock %}
{% block footer %}
    {{ super() }}
   <script src="https://code.highcharts.com/highcharts.js"></script>
   <script src="https://code.highcharts.com/modules/exporting.js"></script>
   <script src="{{ url_for('static', filename='js/tabify.js') }}"></script>

   <script src="{{ url_for('static', filename='js/jquery.countTo.js') }}"></script>
   <script src="{{ url_for('static', filename='js/jquery.easing.1.3.js') }}"></script>
   <script>
   	    let transactions = tabify(JSON.parse({{session['special_query_list'][2]['response'] | tojson}}));
   	    let top5 = tabify(JSON.parse({{session['special_query_list'][0]['response'] | tojson}}));
   	    
   	    let higestWithdrawal = tabify(JSON.parse({{session['special_query_list'][1]['response'] | tojson}})).pop();
   	    let highestDeposit = tabify(JSON.parse({{session['special_query_list'][3]['response'] | tojson}})).pop();

   	    function setvalues(hclass, obj, type) {
   	    	jQuery(hclass).data('to', obj.amount);
   	    	jQuery(hclass).next('.cust_data').find('span.customer').text(obj.customer);
   	    	jQuery(hclass).next('.cust_data').find('span.branch').text(obj.branch);
   	    }
   	    setvalues('.timer.deposit',highestDeposit, 'deposit' );
   	    setvalues('.timer.withdrawal',higestWithdrawal, 'withdrawal' );

   		$(document).ready(function () {


   			//build bar graph // How many transaction each branch did?
   			
   			let deposits = transactions[0];
   			let withdrawal = transactions[1];
   			let barCategories = [];
   			let depositsValues = [];
   			let withDrawalValues = [];
   			for (v of Object.values(deposits)) {
				if (v.transaction_by_branch) {
					barCategories.push(v.transaction_by_branch);
					depositsValues.push(v.doc_count);
				}
			}
			for (v of Object.values(withdrawal)) {
				if (v.transaction_by_branch) {
					withDrawalValues.push(v.doc_count);
				}
			}
   			Highcharts.chart('bar_container', {
			    chart: {
			        type: 'column'
			    },
			    title: {
			        text: 'Transaction Volume'
			    },
			    subtitle: {
			        text: 'How many transaction each branch did?'
			    },
			    xAxis: {
			        categories: barCategories,
			        crosshair: true
			    },
			    yAxis: {
			        min: 0,
			        title: {
			            text: 'Amount (USD mn)'
			        }
			    },
			    tooltip: {
			        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
			        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
			            '<td style="padding:0"><b>{point.y:.1f} (USD mn)</b></td></tr>',
			        footerFormat: '</table>',
			        shared: true,
			        useHTML: true
			    },
			    plotOptions: {
			        column: {
			            pointPadding: 0,
			            borderWidth: 0,
			            pointWidth: 15,
			        }
			    },
			    series: [{
			        name: 'Withdrawal',
			        data: withDrawalValues

			    }, {
			        name: 'Deposit',
			        data: depositsValues

			    }
			    ]
			});


		    // Build the  pie chart // Top 5 customers by balance
		    let pieData = [];
		    let maxBalance = 0;
		    let maxKey = 0;
		    for (v in top5) {
				let customer = top5[v];
				if (maxBalance < customer.balance) {
					maxBalance = customer.balance;
					maxKey = v;
				}

				pieData.push({
					name : customer.customer, 
					y : customer.balance
				});
			
			}
			//slice out the max customer
			pieData[maxKey] = Object.assign(pieData[maxKey], {sliced:true, selected:true});

		    Highcharts.chart('container', {
		        chart: {
		            plotBackgroundColor: null,
		            plotBorderWidth: null,
		            plotShadow: false,
		            type: 'pie'
		        },
		        title: {
		            text: 'Top 5 customers by balance'
		        },
		        tooltip: {
		            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		        },
		        plotOptions: {
		            pie: {
		                allowPointSelect: true,
		                cursor: 'pointer',
		                dataLabels: {
		                    enabled: false
		                },
		                showInLegend: true
		            }
		        },
		        series: [{
		            name: 'Customers',
		            colorByPoint: true,
		            data: pieData
		        }]
		    });

		    //counter for number
		    $('.timer').countTo();

		    // question form submission
		    $('#questions_form').submit(function (e) {
		    	e.preventDefault();
		    	$.ajax({
		    		'url': '/questions', 
		    		'method' : 'POST', 
		    		'dataType': 'json',
		    		'data': $('#questions_form').serialize(),
		    		'success': function  (response) {
		    			//@todo handle various kinds of responses
		    			let chartData = tabify(response);
		    			let chartCategories = [];
		    			let chartValues = [];
		    			// get the y axis plot from the question string. 
		    			let question = $('#questions_form input[type="text"]').val();
		    			let matches = question.match(/(?:(?:sum of)|(?:max of)) (\w+?) /);
		    			let yLabel = '';
		    			if (matches[1]) {
		    				let yLabel = matches[1];
		    			} else {
		    				alert('Question not supported yet');
		    				return;
		    			}
		    			// get the plotted value 
		    			matches = question.match(/(\w+?) = (.+)/);
		    			let plotLabel = matches[2];
		    			for (v of Object.values(chartData)) {
							if (v.string_field_agg) {
								chartCategories.push(v.string_field_agg);
								chartValues.push(v.numeric);
							}
						}
						$('#answer_container').animate({height:400}, {duration: 1000, easing: 'easeOutCirc'});
						Highcharts.chart('answer_container', {
						    chart: {
						        type: 'column'
						    },
						    title: {
						        text: 'Result'
						    },
						    subtitle: {
						        text: question,
						    },
						    xAxis: {
						        categories: chartCategories,
						        crosshair: true
						    },
						    yAxis: {
						        min: 0,
						        title: {
						            text:  capitalize(yLabel)
						        }
						    },
						    tooltip: {
						        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
						        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
						            '<td style="padding:0"><b>{point.y:.1f}</b></td></tr>',
						        footerFormat: '</table>',
						        shared: true,
						        useHTML: true
						    },
						    plotOptions: {
						        column: {
						            pointPadding: 0,
						            borderWidth: 0,
						            pointWidth: 25,
						        }
						    },
						    series: [{
						        name: plotLabel,
						        data: chartValues
						    }
						    ]
						});

		    			$('#questions_form')[0].reset();
		    		}
		    	}) 
		    });
		});

	function capitalize(str) {
		return str.toLowerCase().replace(/\b[a-z]/g, function(letter) {
				    return letter.toUpperCase();
				});
	}
   </script>

{% endblock %}